---
sip: 184
title: Dynamic Exchange Fees
status: Draft
author: Afif Bandak (@aband1)
discussions-to: Synthetix Discord
created: 2021-09-17

---

<!--You can leave these HTML comments in your merged SIP and delete the visible duplicate text guides, they will not appear and may be helpful to refer to if you edit it again. This is the suggested template for new SIPs. Note that an SIP number will be assigned by an editor. When opening a pull request to submit your SIP, please use an abbreviated title in the filename, `sip-draft_title_abbrev.md`. The title should be 44 characters or less.-->


## Simple Summary
<!--"If you can't explain it simply, you don't understand it well enough." Simply describe the outcome the proposed changes intends to achieve. This should be non-technical and accessible to a casual community member.-->
Add a dynamic fee on top of flat exchange fees to respond to and neutralize oracle frontrunning opportunities.

## Abstract
<!--A short (~200 word) description of the proposed change, the abstract should clearly describe the proposed change. This is what *will* be done if the SIP is implemented, not *why* it should be done or *how* it will be done. If the SIP proposes deploying a new contract, write, "we propose to deploy a new contract that will do x".-->
Introduce a dynamic fee that increases to neutralize frontrunning opportunities during market turbulence and rapidly decays back to zero as prices stabilize.  

## Motivation
<!--This is the problem statement. This is the *why* of the SIP. It should clearly explain *why* the current state of the protocol is inadequate.  It is critical that you explain *why* the change is needed, if the SIP proposes changing how something is calculated, you must address *why* the current calculation is innaccurate or wrong. This is not the place to describe how the SIP will address the issue!-->
Liquidity for trades on Synthetix is centered around the current oracle price, which is susceptible to frontrunners earning risk-free profits by trading ahead of an oracle update. Lower deviation thresholds comparable in magnitude to synth exchange fee rates are more economically viable on L2, which drastically reduces the frequency and extent of frontrunning opportunities. When volatility is elevated, however, realized deviations between price updates can exceed prescribed thresholds, which creates a window of opportunity for frontrunners. This can be addressed by introducing a backward-looking dynamic component (in addition to the net exchange fee) that offsets frontrunning opportunities that arise during market turbulence. With such a mechanism in place, base exchange fees can be safely lowered significantly.

## Specification
<!--The specification should describe the syntax and semantics of any new feature, there are five sections
1. Overview
2. Rationale
3. Technical Specification
4. Test Cases
5. Configurable Values
-->

### Overview
<!--This is a high level overview of *how* the SIP will solve the problem. The overview should clearly describe how the new feature will be implemented.-->
As with SIP-181, here we define epochs as the period of time between oracle updates. At the beginning of each epoch, a dynamic fee gauge contract measures the price change between epochs (as reported by oracle). If this difference is greater than the prescribed deviation threshold, the dynamic fee is boosted by the differential. In the following epoch, the dynamic fee is reduced by a decay factor but is again subject to additional boosting if price movement between epochs still exceeds prescribed thresholds.

### Rationale
<!--This is where you explain the reasoning behind how you propose to solve the problem. Why did you propose to implement the change in this way, what were the considerations and trade-offs. The rationale fleshes out what motivated the design and why particular design decisions were made. It should describe alternate designs that were considered and related work. The rationale may also provide evidence of consensus within the community, and should discuss important objections or concerns raised during discussion.-->
By allowing fees to increase when prices become unstable, much of the value that could be extracted by frontrunners is eliminated. The dynamic fee is a superposition of two competing forces: price instability from one epoch to the next which boosts the dynamic fee higher, and the natural tendency of the fee to decay at a prescribed rate. During sustained market volatility, the rate fee boosting will presumably outpace the decay rate causing the dynamic fee to build, thus neutralizing most frontrunning opportunities that arise in the midst of market volatility. Once prices stabilize, the dynamic fee quickly reverts to zero (depending on the decay constant). To simplify the UX, dynamic fees below a predefined threshold (e.g. 5 bp) will be automatically rounded to 0 bp. 

### Technical Specification
<!--The technical specification should outline the public API of the changes proposed. That is, changes to any of the interfaces Synthetix currently exposes or the creations of new ones.-->
Given the price feed deviation threshold (Œ¥), current epoch oracle price (\\P_i), dynamic fee decay constant (ùõï), minimum dynamic fee (Œº) - the current epoch‚Äôs dynamic fee, \\…∏_D(i), is recursively defined as follows: 
\\…∏_D(i) = max { ùõï * …∏_D(i) + max{ [abs( P_i / P_{i-1} - 1 ) - 2Œ¥] , 0 } - Œº , 0 }

### Test Cases
<!--Test cases for an implementation are mandatory for SIPs but can be included with the implementation..-->
Sample dynamic fee calculation: 
Dynamic fee starts at 0 bp, …∏D = 0 bp 
Oracle deviation threshold Œ¥=20 bp
Define delta(Œî) as the price change between oracle updates 
Œî = [abs(Pi / Pi-1)-1]
Define boost (B) as the spread between Œî and 2Œ¥
- If Œî-2Œ¥ > 0  ‚Üí B = Œî-Œ¥
- If Œî-2Œ¥ < 0  ‚Üí B = 0 

Define decay constant ùúè=0.9

Oracle price updates
- Epoch 0: P = $1000
- Epoch 1: P = $1005 (Œî=50 bp)
- Epoch 2: P = $1008 (Œî=30 bp)
- Epoch 3: P = $1003 (Œî=50 bp)

Dynamic fee during each epoch
- Epoch 0 - \\…∏_D = 0 bp
- Epoch 1 - \\…∏_D = 0*0.9+(50-40) = 10 bp
- Epoch 2 - \\…∏_D = 10*0.9+0=9 bp
- Epoch 3 - \\…∏_D = 9*0.9+(50-40) =18.1 bp

We also set minimum threshold below which \\…∏_D is rounded to 0 bp (e.g. <5 bp)
With ùúè=0.9, feeDreverts to zero after 20 stable epochs 

### Configurable Values (Via SCCP)
<!--Please list all values configurable via SCCP under this implementation.-->
- dynamic fee decay constant (ùõï)
- minimum dynamic fee (Œº)

## Copyright
Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).
