---
sip: 381
title: Multi-Collateral Margin Support - Perps V3
network: Base
status: Draft
type: Governance
author: 'Sunny Vempati (@sunnyvempati), kaleb (@kaleb-keny), Leo (@leomassazza)'
created: 2024-04-28
---

<!--You can leave these HTML comments in your merged SIP and delete the visible duplicate text guides, they will not appear and may be helpful to refer to if you edit it again. This is the suggested template for new SIPs. Note that an SIP number will be assigned by an editor. When opening a pull request to submit your SIP, please use an abbreviated title in the filename, `sip-draft_title_abbrev.md`. The title should be 44 characters or less.-->

## Simple Summary

<!--"If you can't explain it simply, you don't understand it well enough." Simply describe the outcome the proposed changes intends to achieve. This should be non-technical and accessible to a casual community member.-->

This sip introduces multi-collaterals to perps v3, different collateral types would be wrapped or bought from the spot market  (e.g. snxETH, snxBTC) and accordingly be used as margin that supports positions on Peprs V3.

## Abstract

<!--A short (~200 word) description of the proposed change, the abstract should clearly describe the proposed change. This is what *will* be done if the SIP is implemented, not *why* it should be done or *how* it will be done. If the SIP proposes deploying a new contract, write, "we propose to deploy a new contract that will do x".-->

This sip introduces multi-collateral margining into perps v3, the `setCollateralConfiguration` function, which can be used to permit new collaterals to be used as margin. Governance can designate the type of accepted collateral, as well as  specify parameters that calibrate the haircut applied and the maximum exposure allowed in a given super market.

## Motivation

<!--This is the problem statement. This is the *why* of the SIP. It should clearly explain *why* the current state of the protocol is inadequate.  It is critical that you explain *why* the change is needed, if the SIP proposes changing how something is calculated, you must address *why* the current calculation is inaccurate or wrong. This is not the place to describe how the SIP will address the issue!-->

The functionality is a user experience improvement, where collaterals of different types can be posted to support a position. Coincidentally, this additional feature also allows opening delta neutral positions, a thought after feature, for farming funding rates.

## Rationale

<!--This is where you explain the reasoning behind how you propose to solve the problem. Why did you propose to implement the change in this way, what were the considerations and trade-offs. The rationale fleshes out what motivated the design and why particular design decisions were made. It should describe alternate designs that were considered and related work. The rationale may also provide evidence of consensus within the community, and should discuss important objections or concerns raised during discussion.-->

The key design decision that was considered in the process of this sip, was whether to distribute the liquidated collateral directly to LP's or use the spot market in order to swap the collateral to snxUSD and pay down LP's debt. In order to improve the resilience of the perp market, in light of the spot market implementation that involves a price impact in order to rebalance the skew, sending the collateral directly to LP's was favored over the fire-sale option, in order to simplify the complexity. 


## Technical Specification

<!--The technical specification should outline the public API of the changes proposed. That is, changes to any of the interfaces Synthetix currently exposes or the creations of new ones.-->

### `CollateralConfigurationModule`


```solidity
    function setCollateralConfiguration(
        uint128 collateralId,
        uint256 maxCollateralAmount,
        uint256 upperLimitDiscount,
        uint256 lowerLimitDiscount,
        uint256 discountScalar
    ) external;
```

Allows configuration of eligible collaterals that can be used as margin. Governance can designate the following:
-  `collateralId`, refers to the synthId, where 0 refers to snxUSD, and 1 points to snxETH for example
- `maxCollateralAmount`, specified in the collateral's native currency, being the maximum amount that can be used as margin in a given perp supermarket
- The discount on the margin is 0% on snxUSD and can be configurable for other collaterals. The latter is bounded with the `upperLimitDiscount` and `lowerLimitDiscount`, for example a lower limit of 2% and upper limit of 5%. The discount should take into account the liquidity of the collateral being used, since after a given liquidation, stakers will receive the collateral and could to sell it for snxUSD on the spot market, or withdraw it from the wrapper if available.
- The `discountScalar` is a configurable that allows parameterization of the discount which is calculated with the below calculation:

$ unboundedHaircut = \frac{marginSize.discountScalar}{skewScale} $
$ boundedHaircut = \min(\max(unboundedHaircut;lowerLimitDiscount);upperLimitDiscount)$


### RewardDistributor

Distributing margin to the different liquidity providers that hook onto the perp market would be done with the help of the v3 RewardDistributor which is outlined in [SIP-305](https://sips.synthetix.io/sips/sip-305/).


### LiquidationModule

XXXXXXXx


##### Edge Cases

XXXXXXXXX


### Test Cases

<!--Test cases for an implementation are mandatory for SIPs but can be included with the implementation..-->

Relevant tests will be developed during implementation.

### Configurable Values (Via SCCP)

<!--Please list all values configurable via SCCP under this implementation.-->

N/A

## Copyright

Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).
